rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // FUNCIONES DE AYUDA
    // ============================================
    
    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica si el usuario es el propietario del documento
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Verifica si el usuario tiene rol de coach (usando Custom Claims)
    // Fallback: lee el documento del usuario si no hay custom claims
    function isCoach() {
      return isAuthenticated() && (
        request.auth.token.role == 'coach' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'coach'
      );
    }
    
    // Verifica si el usuario tiene rol de atleta
    function isAthlete() {
      return isAuthenticated() && (
        request.auth.token.role == 'athlete' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'athlete'
      );
    }
    
    // Verifica si el usuario tiene rol de atleta avanzado
    function isAdvancedAthlete() {
      return isAuthenticated() && (
        request.auth.token.role == 'advanced_athlete' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'advanced_athlete'
      );
    }
    
    // Verifica si el usuario es coach o atleta avanzado
    function isCoachOrAdvanced() {
      return isCoach() || isAdvancedAthlete();
    }
    
    // Verifica si el coach tiene asignado a un atleta específico
    function isCoachOfAthlete(athleteId) {
      return isCoach() && (
        get(/databases/$(database)/documents/users/$(athleteId)).data.coachId == request.auth.uid
      );
    }
    
    // Verifica que los datos de entrada contengan un campo específico
    function hasField(field) {
      return field in request.resource.data;
    }
    
    // Verifica el tamaño máximo de una cadena
    function isValidString(field, maxLength) {
      return request.resource.data[field] is string && 
             request.resource.data[field].size() <= maxLength;
    }

    // ============================================
    // REGLAS POR COLECCIÓN
    // ============================================

    // ----------------------------------------
    // USERS (Perfiles de usuarios)
    // ----------------------------------------
    // - Cualquier autenticado puede leer (para búsqueda de coaches/atletas)
    // - Solo el propietario puede crear/editar su perfil
    // - Nadie puede eliminar (solo admin desde consola)
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() 
                    && isOwner(userId)
                    && hasField('role')
                    && request.resource.data.role in ['coach', 'athlete', 'advanced_athlete'];
      
      allow update: if isAuthenticated() 
                    && isOwner(userId)
                    // No permitir cambiar el rol una vez establecido
                    && (!('role' in request.resource.data) || 
                        request.resource.data.role == resource.data.role);
      
      allow delete: if false;
    }

    // ----------------------------------------
    // EXERCISES (Biblioteca de ejercicios)
    // ----------------------------------------
    // - Cualquier autenticado puede leer
    // - Coaches y atletas avanzados pueden crear/editar/eliminar
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      
      allow create: if isCoachOrAdvanced()
                    && hasField('name')
                    && hasField('muscleGroups')
                    && hasField('coachId')
                    && request.resource.data.coachId == request.auth.uid;
      
      allow update: if isCoachOrAdvanced()
                    // Creador o atleta avanzado del mismo coach
                    && (resource.data.coachId == request.auth.uid || 
                        !('coachId' in resource.data) ||
                        (isAdvancedAthlete() && 
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coachId == resource.data.coachId));
      
      allow delete: if isCoachOrAdvanced()
                    && (resource.data.coachId == request.auth.uid ||
                        (isAdvancedAthlete() && 
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coachId == resource.data.coachId));
    }

    // ----------------------------------------
    // ROUTINES (Rutinas de entrenamiento)
    // ----------------------------------------
    // - Atletas leen sus propias rutinas
    // - Coaches leen/escriben rutinas que ellos crearon
    // - Atletas avanzados tienen acceso completo a sus propias rutinas
    match /routines/{routineId} {
      allow read: if isAuthenticated() && (
        // Atleta lee su rutina asignada
        resource.data.athleteId == request.auth.uid ||
        // Coach lee rutinas que creó
        resource.data.coachId == request.auth.uid ||
        // Coach lee rutinas de sus atletas
        isCoachOfAthlete(resource.data.athleteId)
      );
      
      allow create: if isCoachOrAdvanced()
                    && hasField('coachId')
                    && request.resource.data.coachId == request.auth.uid
                    && hasField('athleteId')
                    && hasField('name');
      
      allow update: if isCoachOrAdvanced()
                    && (resource.data.coachId == request.auth.uid ||
                        (isAdvancedAthlete() && resource.data.athleteId == request.auth.uid));
      
      allow delete: if isCoachOrAdvanced()
                    && (resource.data.coachId == request.auth.uid ||
                        (isAdvancedAthlete() && resource.data.athleteId == request.auth.uid));
    }

    // ----------------------------------------
    // TRAINING_LOGS (Registros de entrenamientos)
    // ----------------------------------------
    // - Atletas leen/escriben sus propios logs
    // - Coaches leen los logs de sus atletas
    match /training_logs/{logId} {
      allow read: if isAuthenticated() && (
        resource.data.athleteId == request.auth.uid ||
        isCoachOfAthlete(resource.data.athleteId) ||
        isCoach() // Coaches pueden ver todos para análisis global
      );
      
      allow create: if isAuthenticated()
                    && hasField('athleteId')
                    && request.resource.data.athleteId == request.auth.uid
                    && hasField('date');
      
      allow update: if isAuthenticated()
                    && resource.data.athleteId == request.auth.uid;
      
      allow delete: if isAuthenticated()
                    && resource.data.athleteId == request.auth.uid;
    }

    // ----------------------------------------
    // WORKOUTS (Entrenamientos completados)
    // ----------------------------------------
    // Similar a training_logs
    match /workouts/{workoutId} {
      allow read: if isAuthenticated() && (
        resource.data.athleteId == request.auth.uid ||
        isCoachOfAthlete(resource.data.athleteId) ||
        isCoach()
      );
      
      allow create: if isAuthenticated()
                    && hasField('athleteId')
                    && request.resource.data.athleteId == request.auth.uid;
      
      allow update: if isAuthenticated()
                    && resource.data.athleteId == request.auth.uid;
      
      allow delete: if isAuthenticated()
                    && resource.data.athleteId == request.auth.uid;
    }

    // ----------------------------------------
    // WORKOUT_SETS (Sets individuales de entrenamientos)
    // ----------------------------------------
    match /workout_sets/{setId} {
      allow read: if isAuthenticated() && (
        resource.data.athleteId == request.auth.uid ||
        isCoachOfAthlete(resource.data.athleteId) ||
        isCoach()
      );
      
      allow create: if isAuthenticated()
                    && hasField('athleteId')
                    && request.resource.data.athleteId == request.auth.uid
                    && hasField('sessionId')
                    && hasField('exerciseId');
      
      allow update: if isAuthenticated()
                    && resource.data.athleteId == request.auth.uid;
      
      allow delete: if isAuthenticated()
                    && resource.data.athleteId == request.auth.uid;
    }

    // ----------------------------------------
    // BODY_MEASUREMENTS (Medidas corporales)
    // ----------------------------------------
    // - Atletas leen/escriben sus propias medidas
    // - Coaches leen las medidas de sus atletas
    match /body_measurements/{measurementId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isCoachOfAthlete(resource.data.userId)
      );
      
      allow create: if isAuthenticated()
                    && hasField('userId')
                    && (request.resource.data.userId == request.auth.uid ||
                        isCoachOfAthlete(request.resource.data.userId))
                    && hasField('date');
      
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }
    
    // ----------------------------------------
    // MEASUREMENTS — DEPRECADO
    // ----------------------------------------
    // Colección legacy. Usar 'body_measurements' en su lugar.
    // Se deniega todo acceso para forzar la migración.
    match /measurements/{measurementId} {
      allow read, write: if false;
    }
    
    // ----------------------------------------
    // NOTIFICATIONS (Notificaciones)
    // ----------------------------------------
    // - Los usuarios leen sus propias notificaciones
    // - Solo el servidor puede escribir (via Admin SDK)
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.athleteId == request.auth.uid ||
        resource.data.coachId == request.auth.uid
      );
      
      // Permitir actualizar solo el campo 'read' para marcar como leída
      allow update: if isAuthenticated() 
                    && (resource.data.userId == request.auth.uid ||
                        resource.data.athleteId == request.auth.uid)
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      allow create, delete: if false; // Solo servidor
    }
    
    // ----------------------------------------
    // AI_ANALYSIS (Análisis de IA - futuro)
    // ----------------------------------------
    match /ai_analysis/{analysisId} {
      allow read: if isAuthenticated() && (
        resource.data.athleteId == request.auth.uid ||
        resource.data.coachId == request.auth.uid ||
        isCoachOfAthlete(resource.data.athleteId)
      );
      
      allow write: if false; // Solo servidor (Admin SDK)
    }
    
    // ----------------------------------------
    // PROGRESS_RECORDS (Récords personales - futuro)
    // ----------------------------------------
    match /progress_records/{recordId} {
      allow read: if isAuthenticated() && (
        resource.data.athleteId == request.auth.uid ||
        isCoachOfAthlete(resource.data.athleteId) ||
        isCoach()
      );
      
      allow create, update: if isAuthenticated()
                            && hasField('athleteId')
                            && request.resource.data.athleteId == request.auth.uid;
      
      allow delete: if isAuthenticated()
                    && resource.data.athleteId == request.auth.uid;
    }

    // ============================================
    // REGLA POR DEFECTO - DENEGAR TODO LO DEMÁS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
